name: Build Android APK

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Clean up previous Android platform
      run: |
        echo "=== Cleaning up previous builds ==="
        rm -rf android
        rm -f capacitor.config.*
        rm -rf .capacitor
        
    - name: Install dependencies
      run: |
        npm install
        npm install @capacitor/android@5.5.0 @capacitor/cli@5.5.0
        
    - name: Build web app
      run: npm run build
    
    - name: Create capacitor config
      run: |
        echo '{"appId":"com.royan.app","appName":"RoyanApp","webDir":"out"}' > capacitor.config.json
        
    - name: Add Android platform
      run: |
        echo "=== Adding Android platform ==="
        npx cap add android
        
    - name: Fix Kotlin dependencies
      run: |
        echo "=== Fixing Kotlin dependency conflicts ==="
        
        # Add Kotlin version to root build.gradle
        if [ -f "android/build.gradle" ]; then
          sed -i '1i buildscript {\n    ext.kotlin_version = "1.8.22"\n}' android/build.gradle
          
          # Add Kotlin plugin dependency
          sed -i '/classpath "com.android.tools.build:gradle:/a\        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"' android/build.gradle
        fi
        
        # Fix duplicate Kotlin libraries in app build.gradle
        if [ -f "android/app/build.gradle" ]; then
          # Create the fix content
          FIX_CONTENT='    configurations.all {\n        exclude group: "org.jetbrains.kotlin", module: "kotlin-stdlib-jdk7"\n        exclude group: "org.jetbrains.kotlin", module: "kotlin-stdlib-jdk8"\n    }\n    implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"'
          
          # Insert after dependencies {
          sed -i "/dependencies {/a $FIX_CONTENT" android/app/build.gradle
        fi
        
        echo "=== Updated build.gradle files ==="
        head -20 android/build.gradle
        echo "..."
        tail -20 android/app/build.gradle
    
    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Build APK
      run: |
        echo "=== Building APK ==="
        cd android
        chmod +x gradlew
        ./gradlew clean assembleDebug --stacktrace
        
    - uses: actions/upload-artifact@v4
      with:
        name: apk
        path: android/app/build/outputs/apk/debug/*.apk
